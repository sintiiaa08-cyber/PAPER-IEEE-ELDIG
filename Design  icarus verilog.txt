module bottle_fsm (
    input  wire clk,
    input  wire reset,

    input  wire i_bottle_detect,
    input  wire i_critical,
    input  wire i_fill_complete,
    input  wire i_positioned,
    input  wire i_removed,

    output reg  o_motor_servo,
    output reg  o_motor_stepper,
    output reg  o_pump_motor,
    output reg  o_valve_solenoid,

    output reg [1:0] state_out
);

    localparam IDLE        = 2'd0;
    localparam POSITIONING = 2'd1;
    localparam FILLING     = 2'd2;

    reg [1:0] state, next_state;

    // STATE REGISTER
    always @(posedge clk or posedge reset) begin
        if (reset)
            state <= IDLE;
        else
            state <= next_state;
    end

    // NEXT STATE LOGIC
    always @(*) begin
        next_state = state;
        case (state)
            IDLE:
                if (i_bottle_detect)
                    next_state = POSITIONING;

            POSITIONING:
                if (i_positioned)
                    next_state = FILLING;

            FILLING:
                if (i_fill_complete)
                    next_state = IDLE;
        endcase
    end

    // REGISTERED OUTPUTS (BASED ON NEXT_STATE)
    always @(posedge clk or posedge reset) begin
        if (reset) begin
            o_motor_servo    <= 0;
            o_motor_stepper  <= 0;
            o_pump_motor     <= 0;
            o_valve_solenoid <= 0;
        end else begin
            o_motor_servo    <= 0;
            o_motor_stepper  <= 0;
            o_pump_motor     <= 0;
            o_valve_solenoid <= 0;

            case (next_state)
                POSITIONING: begin
                    o_motor_servo   <= 1;
                    o_motor_stepper <= 1;
                end
                FILLING: begin
                    o_pump_motor     <= 1;
                    o_valve_solenoid <= 1;
                end
            endcase
        end
    end

    // STATE OUTPUT
    always @(posedge clk or posedge reset) begin
        if (reset)
            state_out <= IDLE;
        else
            state_out <= next_state;
    end

endmodule
